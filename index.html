<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Daily Food Sales Report — PDF Fix</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--accent:#0b63c6;--muted:#666;--border:#d9dbe0;}
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:12px;}
  .wrap{max-width:1200px;margin:12px auto;}
  .sheet{background:#fff;border:1px solid #000;padding:12px;border-radius:6px;}
  /* Header like your Dry Store sample */
  .header{display:flex;align-items:center;gap:12px;border-bottom:1px solid #000;padding-bottom:8px;margin-bottom:12px}
  .logo{width:120px}
  .title{flex:1;text-align:center}
  .title h1{margin:0;font-size:22px}
  .title .sub{font-size:12px;color:var(--muted);margin-top:4px}
  .meta{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .meta .m{flex:1 1 160px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;box-sizing:border-box;font-size:14px}
  .meal{margin-bottom:12px}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:13px;min-width:1200px}
  th,td{border:1px solid #000;padding:8px;text-align:center}
  th{background:#f3f6fb;font-weight:700}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{padding:8px 12px;border-radius:6px;border:0;color:#fff;background:var(--accent);cursor:pointer;font-weight:700}
  .btn.pdf{background:#6f42c1}
  .btn.reset{background:#dc3545}
  .btn.lock{background:#28a745}
  .ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  /* ensure printable look */
  @media print{ .controls{display:none} .wrap{margin:0} }
</style>
</head>
<body>
<div class="wrap">
  <div class="sheet" id="report-sheet">
    <div class="header">
      <img class="logo" src="logo.png" alt="logo">
      <div class="title">
        <h1>Daily Food Sales Report</h1>
        <div class="sub">Konarak F&B — Kitchen / Counter sales</div>
      </div>
      <div style="width:160px">
        <label>Date</label><input id="rdate" type="date" />
      </div>
    </div>

    <div class="meta">
      <div class="m"><label>Building</label><input id="building"></div>
      <div class="m"><label>Floor</label><input id="floor"></div>
      <div class="m"><label>Counter</label><input id="counter"></div>
      <div class="m"><label>Prepared By</label><input id="prepared"></div>
      <div class="m"><label>Verified By</label><input id="verified"></div>
    </div>

    <!-- Full wide table same structure as Dry Store but for sales -->
    <div class="table-wrap">
      <table id="mainTable">
        <thead>
          <tr>
            <th style="width:48px">S.No</th>
            <th style="width:320px">Item / Meal (Breakfast / Lunch / Dinner)</th>
            <th>Opening Qty</th>
            <th>Produced Qty</th>
            <th>Total Avl.</th>
            <th>Sold Qty</th>
            <th>Closing Qty</th>
            <th>Rate (₹)</th>
            <th>Total Sales (₹)</th>
            <th style="width:140px">Meal</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- initial empty rows -->
        </tbody>
      </table>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="addRow">+ Add Row</button>
      <button class="btn lock" id="lockRows">Save & Lock</button>
      <button class="btn pdf" id="downloadPdf">Download PDF</button>
      <button class="btn reset" id="resetAll">Reset</button>
      <div style="flex:1"></div>
      <div style="min-width:220px">
        <label>Saved Reports</label>
        <div id="savedList" style="border:1px dashed #ccc;padding:8px;border-radius:6px;max-height:140px;overflow:auto;background:#fafcff">— none —</div>
      </div>
    </div>

  </div>
</div>

<script>
/* --------- table & rows setup ---------- */
const tbody = document.getElementById('tbody');
const savedList = document.getElementById('savedList');

function addEmptyRow(data){
  const row = document.createElement('tr');
  row.innerHTML = `
    <td class="sn"></td>
    <td><input class="item" style="width:100%"></td>
    <td><input class="opening" type="number" min="0" value="${data?.opening ?? 0}"></td>
    <td><input class="produced" type="number" min="0" value="${data?.produced ?? 0}"></td>
    <td><input class="available" readonly></td>
    <td><input class="sold" type="number" min="0" value="${data?.sold ?? 0}"></td>
    <td><input class="closing" readonly></td>
    <td><input class="rate" type="number" step="0.01" min="0" value="${data?.rate ?? 0}"></td>
    <td><input class="total" readonly></td>
    <td>
      <select class="mealSelect">
        <option value="Breakfast">Breakfast</option>
        <option value="Lunch">Lunch</option>
        <option value="Dinner">Dinner</option>
      </select>
      <div style="margin-top:6px">
        <button class="btn ghost small btn-del">Del</button>
      </div>
    </td>`;
  tbody.appendChild(row);
  bindRow(row);
  renumber();
  recalcRow(row);
}

/* initial rows */
for(let i=0;i<6;i++) addEmptyRow();

/* bind events */
function bindRow(tr){
  tr.querySelectorAll('input, select').forEach(el=>{
    el.addEventListener('input', ()=>{ recalcRow(tr); });
  });
  tr.querySelector('.btn-del').addEventListener('click', ()=>{ tr.remove(); renumber(); });
}

function renumber(){
  [...tbody.querySelectorAll('tr')].forEach((tr,i)=> tr.querySelector('.sn').textContent = i+1 );
}

/* recalc for row */
function recalcRow(tr){
  const op = Number(tr.querySelector('.opening').value) || 0;
  const pd = Number(tr.querySelector('.produced').value) || 0;
  const av = op + pd;
  tr.querySelector('.available').value = av;
  let sold = Number(tr.querySelector('.sold').value) || 0;
  if(sold > av){ sold = av; tr.querySelector('.sold').value = sold; }
  tr.querySelector('.closing').value = av - sold;
  const rate = Number(tr.querySelector('.rate').value) || 0;
  tr.querySelector('.total').value = (sold * rate).toFixed(2);
}

/* add/delete rows */
document.getElementById('addRow').addEventListener('click', ()=> addEmptyRow());

/* lock rows - disable inputs */
document.getElementById('lockRows').addEventListener('click', ()=>{
  [...tbody.querySelectorAll('input,select')].forEach(i=>i.disabled=true);
  alert('Rows locked (inputs disabled). Use Download PDF to export.');
});

/* reset */
document.getElementById('resetAll').addEventListener('click', ()=>{
  if(!confirm('Reset entire form?')) return;
  tbody.innerHTML = '';
  for(let i=0;i<6;i++) addEmptyRow();
});

/* autosave/display saved list (simple) */
function refreshSavedList(){
  const keys = Object.keys(localStorage).filter(k=>k.startsWith('daily_sales:'));
  if(!keys.length){ savedList.innerHTML = '— none —'; return; }
  savedList.innerHTML = '';
  keys.forEach(k=>{
    const nm = k.replace('daily_sales:','');
    const wrap = document.createElement('div');
    wrap.style.display='flex'; wrap.style.justifyContent='space-between'; wrap.style.padding='6px 4px';
    wrap.innerHTML = `<div style="font-weight:700">${nm}</div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost small" data-load="${nm}">Load</button>
        <button class="btn reset small" data-del="${nm}">Del</button>
      </div>`;
    savedList.appendChild(wrap);
  });
}
refreshSavedList();

/* Save current to localStorage with provided name */
function collectData(){
  const meta = {
    date: document.getElementById('rdate').value || '',
    building: document.getElementById('building').value || '',
    floor: document.getElementById('floor').value || '',
    counter: document.getElementById('counter').value || '',
    prepared: document.getElementById('prepared').value || '',
    verified: document.getElementById('verified').value || ''
  };
  const rows = [...tbody.querySelectorAll('tr')].map(tr=>({
    item: tr.querySelector('.item').value || '',
    opening: tr.querySelector('.opening').value || '',
    produced: tr.querySelector('.produced').value || '',
    available: tr.querySelector('.available').value || '',
    sold: tr.querySelector('.sold').value || '',
    closing: tr.querySelector('.closing').value || '',
    rate: tr.querySelector('.rate').value || '',
    total: tr.querySelector('.total').value || '',
    meal: tr.querySelector('.mealSelect').value || ''
  }));
  return { meta, rows };
}

document.getElementById('lockRows').addEventListener('click', ()=>{
  // also save snapshot if user enters name
  const name = prompt('Enter save name (or leave empty to skip saving):');
  if(name){
    localStorage.setItem('daily_sales:' + name, JSON.stringify(collectData()));
    refreshSavedList();
    alert('Saved as ' + name);
  }
});

/* saved list load/delete */
savedList.addEventListener('click', (ev)=>{
  const load = ev.target.dataset.load;
  const del = ev.target.dataset.del;
  if(load){
    const payload = JSON.parse(localStorage.getItem('daily_sales:'+load));
    if(!payload) return alert('Not found');
    // populate meta
    document.getElementById('rdate').value = payload.meta.date || '';
    document.getElementById('building').value = payload.meta.building || '';
    document.getElementById('floor').value = payload.meta.floor || '';
    document.getElementById('counter').value = payload.meta.counter || '';
    document.getElementById('prepared').value = payload.meta.prepared || '';
    document.getElementById('verified').value = payload.meta.verified || '';
    // populate rows
    tbody.innerHTML = '';
    payload.rows.forEach(r => addEmptyRow(r));
    // after adding, set disabled state? keep editable
    alert('Loaded ' + load);
  } else if(del){
    if(!confirm('Delete saved "'+del+'"?')) return;
    localStorage.removeItem('daily_sales:'+del);
    refreshSavedList();
  }
});

/* ----------- PDF export (LANDSCAPE A4, preserves filled values) ------------- */
document.getElementById('downloadPdf').addEventListener('click', async function(){
  // Recalculate all rows to ensure totals are up to date
  [...tbody.querySelectorAll('tr')].forEach(tr=> recalcRow(tr));

  // Build a printable clone that matches the landscape layout (wide)
  const sheet = document.getElementById('report-sheet');
  const clone = sheet.cloneNode(true);

  // Replace inputs and selects with text nodes that contain their values
  clone.querySelectorAll('input, select, button, .saved-list').forEach(node=>{
    if(node.tagName === 'BUTTON' || node.classList.contains('saved-list')){
      node.remove(); // remove controls from print
      return;
    }
    const val = (node.value !== undefined) ? node.value : node.textContent;
    const span = document.createElement('div');
    span.textContent = val;
    span.style.minHeight = '18px';
    span.style.fontSize = '13px';
    span.style.padding = '2px 4px';
    span.style.boxSizing = 'border-box';
    node.parentNode.replaceChild(span, node);
  });

  // Put clone in wrapper sized to landscape print width for better resolution
  const wrapper = document.createElement('div');
  wrapper.style.width = '1680px'; // wide canvas for landscape A4 fidelity
  wrapper.style.background = '#fff';
  wrapper.style.padding = '18px';
  wrapper.appendChild(clone);

  // Wait for logo image to load (if any)
  const imgs = wrapper.querySelectorAll('img');
  await Promise.all(Array.from(imgs).map(img=>{
    return new Promise(res=> { if(img.complete) return res(); img.onload = res; img.onerror = res; });
  }));

  // Render to canvas
  const canvas = await html2canvas(wrapper, { scale: 1.0, useCORS:true, logging:false, backgroundColor: '#ffffff' });

  // Create landscape A4 PDF and split if necessary
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
  const pageWidth = 297; // mm
  const pageHeight = 210; // mm

  // convert canvas px to mm
  const pxPerMm = canvas.width / pageWidth;
  const imgHeightMm = canvas.height / pxPerMm;
  const imgData = canvas.toDataURL('image/jpeg', 0.95);

  if(imgHeightMm <= pageHeight){
    // single page
    pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, imgHeightMm);
  } else {
    // multi-page: slice by pageHeight
    let yPx = 0;
    const sliceHeightPx = Math.round(pageHeight * pxPerMm);

    while(yPx < canvas.height){
      // create temporary canvas to hold slice
      const tmpCanvas = document.createElement('canvas');
      tmpCanvas.width = canvas.width;
      const h = Math.min(sliceHeightPx, canvas.height - yPx);
      tmpCanvas.height = h;
      const ctx = tmpCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, yPx, canvas.width, h, 0, 0, canvas.width, h);
      const data = tmpCanvas.toDataURL('image/jpeg', 0.95);
      const hMm = h / pxPerMm;
      if(yPx > 0) pdf.addPage();
      pdf.addImage(data, 'JPEG', 0, 0, pageWidth, hMm);
      yPx += h;
    }
  }

  // filename
  const fname = (document.getElementById('building').value || 'DailyFoodSales') + '_' + (document.getElementById('rdate').value || new Date().toISOString().slice(0,10)) + '.pdf';
  pdf.save(fname);
});

/* ---------- initialize defaults ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  if(!document.getElementById('rdate').value) document.getElementById('rdate').value = new Date().toISOString().slice(0,10);
  renumber();
});

</script>
</body>
</html>
