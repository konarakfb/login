<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CTS Cafeteria — Order</title>
<style>
  :root{
    --accent:#f28c2b; /* Konarak orange */
    --bg:#f6f6f6;
    --card:#fff;
  }
  body{font-family:Arial, sans-serif; margin:12px; background:var(--bg); color:#111;}
  h1{color:#222;margin:6px 0 12px}
  .container{max-width:1100px;margin:auto}
  .menu{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
  .prod{
    background:var(--card);
    border:1px solid #ddd;
    border-radius:8px;
    padding:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    min-height:120px;
  }
  .prod img{width:90px;height:90px;object-fit:contain}
  .prod .name{font-weight:700;text-align:center}
  .prod .price{color:#444}
  .prod button{
    background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;
  }

  /* QR Popup */
  #qrPopup{
    position:fixed;inset:0;background:rgba(0,0,0,0.6);
    display:none;align-items:center;justify-content:center;z-index:9999;
  }
  #qrPopup .box{
    background:#fff;padding:16px;border-radius:8px;width:320px;text-align:center;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }
  #qrPopup img{width:260px;height:260px;object-fit:contain}
  .btn-row{display:flex;gap:8px;justify-content:center;margin-top:12px}
  .btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.secondary{background:#777;color:#fff}

  #tokenBox{
    display:none;margin-top:14px;padding:10px;background:#e9fff0;border:1px solid #bfeecb;border-radius:6px;
    max-width:420px;
  }

  /* small screens */
  @media (max-width:480px){
    .prod img{width:72px;height:72px}
  }
</style>
</head>
<body>
  <div class="container">
    <h1>CTS Cafeteria — Order & Pay</h1>
    <p style="margin:6px 0 12px">Tap an item, scan QR to pay on PhonePe, then tap <strong>I Paid — Get Token</strong>. (Customer enters nothing.)</p>

    <div class="menu" id="menu">
      <!-- product cards inserted by JS -->
    </div>

    <div id="tokenBox"></div>
  </div>

  <!-- QR Modal -->
  <div id="qrPopup">
    <div class="box">
      <h3 id="qrTitle">Scan & Pay</h3>
      <img id="qrImg" src="phonepe_qr.png" alt="PhonePe QR">
      <div class="btn-row">
        <button class="btn primary" id="paidBtn">I Paid — Get Token</button>
        <button class="btn secondary" onclick="closeQr()">Cancel</button>
      </div>
    </div>
  </div>

<script>
/*
  CONFIG - edit only these values if needed
*/
const GOOGLE_FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSdPFEHgyH5qnzyuuXHeHMY_OPEQ9YzktjSkz5yM-eg_dKQY9Q/formResponse";
// Google Form entry IDs (from your prefill)
const ENTRY_ITEM = "entry.257563989";   // item name
const ENTRY_TOKEN = "entry.926383089";  // token
const ENTRY_AMT = "entry.677818799";    // amount

// INITIAL TOKEN (user provided)
const INITIAL_TOKEN = "KFB000001"; // starting token (first token to be used)

const PHONEPE_QR_FILENAME = "phonepe_qr.png"; // must exist in same folder

// Products obtained from images you provided (20 items)
const products = [
  { name:"Town Bus Butter Murukku", price:19 },
  { name:"Haldiram's New Mixture", price:20 },
  { name:"Town Bus Onion Murukku", price:19 },
  { name:"Town Bus Madras Mixture", price:19 },
  { name:"Town Bus Garlic Mixture", price:19 },
  { name:"Too Yumm Bhujia", price:19 },
  { name:"Lay's New Spanish Tomato Tango", price:20 },
  { name:"Lay's Hot Sweet Chilli", price:20 },
  { name:"Nabati Wafer Richeese", price:18 },
  { name:"Nabati Wafer PinkLava", price:18 },
  { name:"Haldiram's Khatta Meetha", price:20 },
  { name:"Haldiram's Bhujia Sev", price:20 },
  { name:"Tropicana Guava (juice)", price:19 },
  { name:"Unibic Orange Cookies", price:18 },
  { name:"Unibic Cashew Badam", price:18 },
  { name:"Wholy Vanilla Fudgy Cake", price:27 },
  { name:"Wholy Hazelnut Cake", price:36 },
  { name:"Unibic Choco Chip", price:18 },
  { name:"Unibic Choco Nut", price:18 },
  { name:"Karia's Raigira Peanut Chikki", price:23 }
];
// END CONFIG

// ---------- token handling (persist in localStorage) ----------
function parseInitialToken(t){
  // expects format like KFB000001
  const m = t.match(/([A-Za-z\-]*)(0*)(\d+)$/);
  if(!m) return {prefix:t, startNum:1, pad:6};
  const prefix = m[1] || "";
  const numStr = m[3] || "1";
  const pad = Math.max( numStr.length, 6 );
  const startNum = parseInt(numStr,10);
  return {prefix, startNum, pad};
}

const tokInfo = parseInitialToken(INITIAL_TOKEN);

function getCounter(){
  // store counter as integer in localStorage key 'kfb_counter'
  const key = 'kfb_counter';
  let val = localStorage.getItem(key);
  if(val === null){
    // initialize from INITIAL_TOKEN
    localStorage.setItem(key, String(tokInfo.startNum));
    return tokInfo.startNum;
  }
  return parseInt(val,10);
}
function incrementCounter(){
  const key = 'kfb_counter';
  let n = getCounter();
  n++;
  localStorage.setItem(key, String(n));
  return n;
}
function formatTokenFromNumber(n){
  const pad = tokInfo.pad;
  const numStr = String(n).padStart(pad,'0');
  return `${tokInfo.prefix}${numStr}`;
}
// ---------- end token handling ----------

// render products
function renderProducts(){
  const container = document.getElementById('menu');
  products.forEach((p, idx) => {
    const div = document.createElement('div');
    div.className = 'prod';
    // optional placeholder image (none provided for snack items)
    div.innerHTML = `
      <div class="name">${p.name}</div>
      <div class="price">₹${p.price}</div>
      <button onclick="buyItem(${idx})">Buy</button>
    `;
    container.appendChild(div);
  });
}

// selected product store
let selectedProduct = null;

function buyItem(idx){
  selectedProduct = products[idx];
  document.getElementById('qrTitle').innerText = `${selectedProduct.name} — ₹${selectedProduct.price}`;
  const img = document.getElementById('qrImg');
  img.src = PHONEPE_QR_FILENAME;
  // open popup
  document.getElementById('qrPopup').style.display = 'flex';
}

function closeQr(){
  document.getElementById('qrPopup').style.display = 'none';
}

// create and submit google form prefill via hidden iframe
function submitToGoogleForm(itemName, tokenStr, amount){
  // build URL
  const params = new URLSearchParams();
  params.append(ENTRY_ITEM, itemName);
  params.append(ENTRY_TOKEN, tokenStr);
  params.append(ENTRY_AMT, String(amount));

  const url = `${GOOGLE_FORM_BASE}?${params.toString()}`;

  // create hidden iframe and set src to url -> this submits form quietly
  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = url;
  document.body.appendChild(iframe);

  // remove iframe after some time
  setTimeout(()=> {
    document.body.removeChild(iframe);
  }, 8000);
}

// on Paid button click
document.getElementById('paidBtn').addEventListener('click', ()=> {
  if(!selectedProduct){
    alert('Please select an item first.');
    return;
  }
  // read counter, format token, then increment for next time
  let curr = getCounter(); // e.g. 1
  const tokenStr = formatTokenFromNumber(curr);
  // submit to Google form (hidden)
  submitToGoogleForm(selectedProduct.name, tokenStr, selectedProduct.price);

  // show token to customer
  const box = document.getElementById('tokenBox');
  box.innerHTML = `<strong>Payment recorded ✅</strong><br>Your Token: <span style="font-family:monospace;font-size:18px">${tokenStr}</span><br><small>Please wait while we prepare your order.</small>`;
  box.style.display = 'block';

  // increment stored counter so next token is new
  incrementCounter();

  // close QR modal
  closeQr();
});

// initialize
renderProducts();

</script>
</body>
</html>
