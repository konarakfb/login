<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dry Store Stock Record</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PDF Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {font-family: Arial, sans-serif;background:#f4f4f4;margin:0;padding:12px;color:#111}
.container {max-width:1100px;margin:auto}
.sheet {background:#fff;border:1px solid #000;padding:15px;border-radius:6px;}

/* HEADER */
.header {display:flex;align-items:center;border-bottom:1px solid #000;padding-bottom:12px;margin-bottom:15px;gap:12px}
.header img {width:120px;max-height:80px;object-fit:contain}
.header h1 {flex:1;text-align:center;margin:0;font-size:20px}

@media(max-width:520px){
.header{flex-direction:column;align-items:flex-start}
.header h1{text-align:center;width:100%;margin-top:8px}
}

.top-grid {display:flex;flex-wrap:wrap;gap:10px;margin-bottom:18px}
.top-grid .box {flex:1 1 180px}
label {font-size:13px;color:#555;margin-bottom:4px;display:block}
input[type="text"],input[type="date"]{width:100%;padding:7px;font-size:14px;border:1px solid #aaa;border-radius:4px;box-sizing:border-box}

.table-wrap {overflow-x:auto}
table {width:100%;border-collapse:collapse;table-layout:fixed;font-size:13px;min-width:1000px}
th,td {border:1px solid #000;padding:6px;text-align:center;vertical-align:middle;word-break:break-word}

td input{width:100%;padding:4px;border:1px solid #aaa;border-radius:4px;box-sizing:border-box}

.btn{padding:8px 12px;border-radius:6px;font-weight:bold;color:#fff;border:0;cursor:pointer}
.add{background:#0b63c6}
.save{background:#28a745}
.pdf{background:#6f42c1}
.reset{background:#dc3545}
.ghost{background:#fff;color:#0b63c6;border:1px solid #0b63c6}

.saved-box{margin-top:15px}
.saved-list{border:1px dashed #aaa;padding:8px;background:#fafcff;border-radius:6px;max-height:140px;overflow:auto;font-size:14px}

</style>
</head>
<body>
<div class="container">
<div class="sheet" id="sheet">

<!-- HEADER -->
<div class="header">
 <img src="logo.png" alt="logo">
 <h1>Dry Store Stock Record</h1>
</div>

<!-- TOP FIELDS -->
<div class="top-grid">
 <div class="box"><label>Date</label><input id="date" type="date"></div>
 <div class="box"><label>Vendor Name</label><input id="vendor" type="text"></div>
 <div class="box"><label>Vendor Supervisor</label><input id="supervisor" type="text"></div>
 <div class="box"><label>Building</label><input id="building" type="text"></div>
 <div class="box"><label>Floor</label><input id="floor" type="text"></div>
 <div class="box"><label>Counter</label><input id="counter" type="text"></div>
</div>

<!-- TABLE -->
<div class="table-wrap">
<table id="mainTable">
<thead>
<tr>
<th>S.No</th>
<th>Items</th>
<th>Batch No</th>
<th>Receiving Date</th>
<th>Manufacturing Date</th>
<th>Expiry Date</th>
<th>Shelf Life</th>
<th>Stock Qty</th>
<th>Remarks</th>
<th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
<button class="btn add" id="addBtn">+ Add Row</button>

<!-- FOOTER -->
<div style="margin-top:15px">
 <label>Vendor PoC</label>
 <input type="text" id="vendorpoc" style="width:100%;margin-bottom:10px">
 <label>Verified by F&B Team</label>
 <input type="text" id="verified" style="width:100%">
</div>

<!-- ACTIONS -->
<div style="margin-top:15px;display:flex;flex-wrap:wrap;gap:10px">
 <input id="savename" placeholder="Save name" style="padding:8px;border:1px solid #aaa;border-radius:6px;">
 <button class="btn save" id="saveBtn">Save</button>
 <button class="btn pdf" id="pdfBtn">Download PDF</button>
 <button class="btn reset" id="resetBtn">Reset</button>
</div>

<!-- SAVED LIST -->
<div class="saved-box" id="saved-box">
 <label>Saved Reports</label>
 <div class="saved-list" id="savedList">— none —</div>
</div>

</div>
</div>

<script>
// Data and storage key
let data = [];
const STORAGE = 'dry_store_v1';

// Helpers
function createCellInput(value = '', type = 'text'){
  const input = document.createElement('input');
  input.type = type === 'date' ? 'date' : 'text';
  input.value = value || '';
  return input;
}

function updateIndices(){
  const rows = document.querySelectorAll('#tbody tr');
  rows.forEach((tr, i) => { tr.cells[0].textContent = i+1; });
}

// Add a row; safe to call from buttons
function addRow(v = null){
  const tbody = document.getElementById('tbody');
  const r = v || {item:'', batch:'', rec:'', mfg:'', exp:'', shelf:'', qty:'', remarks:''};
  const tr = document.createElement('tr');

  const idxTd = document.createElement('td'); idxTd.textContent = tbody.children.length + 1;
  const itemTd = document.createElement('td'); itemTd.appendChild(createCellInput(r.item));
  const batchTd = document.createElement('td'); batchTd.appendChild(createCellInput(r.batch));
  const recTd = document.createElement('td'); recTd.appendChild(createCellInput(r.rec, 'date'));
  const mfgTd = document.createElement('td'); mfgTd.appendChild(createCellInput(r.mfg, 'date'));
  const expTd = document.createElement('td'); expTd.appendChild(createCellInput(r.exp, 'date'));
  const shelfTd = document.createElement('td'); shelfTd.appendChild(createCellInput(r.shelf));
  const qtyTd = document.createElement('td'); qtyTd.appendChild(createCellInput(r.qty));
  const remarksTd = document.createElement('td'); remarksTd.appendChild(createCellInput(r.remarks));
  const actionTd = document.createElement('td');
  const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.textContent='Del';
  delBtn.addEventListener('click', function(){ tr.remove(); updateIndices(); });
  actionTd.appendChild(delBtn);

  tr.appendChild(idxTd);
  tr.appendChild(itemTd);
  tr.appendChild(batchTd);
  tr.appendChild(recTd);
  tr.appendChild(mfgTd);
  tr.appendChild(expTd);
  tr.appendChild(shelfTd);
  tr.appendChild(qtyTd);
  tr.appendChild(remarksTd);
  tr.appendChild(actionTd);

  tbody.appendChild(tr);
}

// Collect table data
function collectRows(){
  const rows = [...document.querySelectorAll('#tbody tr')];
  return rows.map(tr=>{
    const inputs = tr.querySelectorAll('input');
    return {
      item: inputs[0].value,
      batch: inputs[1].value,
      rec: inputs[2].value,
      mfg: inputs[3].value,
      exp: inputs[4].value,
      shelf: inputs[5].value,
      qty: inputs[6].value,
      remarks: inputs[7].value
    };
  });
}

// Save to localStorage with name
function saveRows(){
  const name = document.getElementById('savename').value.trim();
  if(!name){ alert('Enter a Save name'); return; }
  const payload = {
    meta: {
      date: document.getElementById('date').value,
      vendor: document.getElementById('vendor').value,
      supervisor: document.getElementById('supervisor').value,
      building: document.getElementById('building').value,
      floor: document.getElementById('floor').value,
      counter: document.getElementById('counter').value,
      vendorpoc: document.getElementById('vendorpoc').value,
      verified: document.getElementById('verified').value
    },
    rows: collectRows()
  };
  localStorage.setItem(STORAGE + '_' + name, JSON.stringify(payload));
  loadSavedList();
  alert('Saved');
}

// Reset
function resetAll(){ if(!confirm('Clear all?')) return; document.getElementById('tbody').innerHTML=''; document.getElementById('date').value=''; document.getElementById('vendor').value=''; document.getElementById('supervisor').value=''; document.getElementById('building').value=''; document.getElementById('floor').value=''; document.getElementById('counter').value=''; document.getElementById('vendorpoc').value=''; document.getElementById('verified').value=''; localStorage.removeItem(STORAGE); }

// Saved list
function loadSavedList(){
  const div = document.getElementById('savedList');
  const keys = Object.keys(localStorage).filter(k=>k.startsWith(STORAGE + '_'));
  if(!keys.length){ div.innerHTML = '— none —'; return; }
  div.innerHTML = '';
  keys.forEach(k=>{
    const name = k.replace(STORAGE + '_','');
    const row = document.createElement('div');
    row.style = 'display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #ccc';
    row.innerHTML = `<b>${name}</b>`;
    const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='6px';
    const loadBtn = document.createElement('button'); loadBtn.className='btn ghost'; loadBtn.textContent='Load'; loadBtn.addEventListener('click', ()=> loadSaved(name));
    const delBtn = document.createElement('button'); delBtn.className='btn reset'; delBtn.textContent='Del'; delBtn.addEventListener('click', ()=> { if(!confirm('Delete saved report?')) return; localStorage.removeItem(STORAGE + '_' + name); loadSavedList(); });
    btns.appendChild(loadBtn); btns.appendChild(delBtn);
    row.appendChild(btns);
    div.appendChild(row);
  });
}

function loadSaved(name){
  const raw = localStorage.getItem(STORAGE + '_' + name);
  if(!raw){ alert('Not found'); return; }
  const d = JSON.parse(raw);
  document.getElementById('date').value = (d.meta && d.meta.date) || '';
  document.getElementById('vendor').value = (d.meta && d.meta.vendor) || '';
  document.getElementById('supervisor').value = (d.meta && d.meta.supervisor) || '';
  document.getElementById('building').value = (d.meta && d.meta.building) || '';
  document.getElementById('floor').value = (d.meta && d.meta.floor) || '';
  document.getElementById('counter').value = (d.meta && d.meta.counter) || '';
  document.getElementById('vendorpoc').value = (d.meta && d.meta.vendorpoc) || '';
  document.getElementById('verified').value = (d.meta && d.meta.verified) || '';

  const tbody = document.getElementById('tbody'); tbody.innerHTML = '';
  (d.rows || []).forEach(r=> addRow(r));
  updateIndices();
}

// PDF download (high quality, slices if needed)
async function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const sheet = document.getElementById('sheet');
  const clone = sheet.cloneNode(true);

  // remove saved list area
  const savedBox = clone.querySelector('#saved-box'); if(savedBox) savedBox.remove();

  // replace inputs with text
  clone.querySelectorAll('input,textarea,select').forEach(el=>{
    if(el.tagName === 'BUTTON') { el.remove(); return; }
    const div = document.createElement('div');
    if(el.type === 'checkbox') div.textContent = el.checked ? '✔' : '✖';
    else div.textContent = el.value || el.textContent || '';
    div.style.padding = '2px 4px';
    div.style.fontSize = '12px';
    el.parentNode.replaceChild(div, el);
  });

  // ensure images loaded
  await Promise.all([...clone.querySelectorAll('img')].map(img=> new Promise(res=>{ if(img.complete) return res(); img.onload=img.onerror=res; })));

  const container = document.createElement('div');
  container.style.position='fixed'; container.style.left='-9999px'; container.style.top='0'; container.style.width='1500px'; container.style.background='#fff';
  container.appendChild(clone); document.body.appendChild(container);

  const canvas = await html2canvas(clone, { scale: 2.5, backgroundColor: '#fff', useCORS: true });
  const imgData = canvas.toDataURL('image/jpeg', 0.90);
  const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
  const pageWidth = 297; const pageHeight = 210;
  const pxPerMm = canvas.width / pageWidth; const imgHeightMm = canvas.height / pxPerMm;

  if(imgHeightMm <= pageHeight){ pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, imgHeightMm); }
  else {
    let y = 0; const slicePx = pageHeight * pxPerMm;
    while(y < canvas.height){
      const sliceCanvas = document.createElement('canvas');
      sliceCanvas.width = canvas.width;
      sliceCanvas.height = Math.min(slicePx, canvas.height - y);
      sliceCanvas.getContext('2d').drawImage(canvas, 0, y, canvas.width, sliceCanvas.height, 0, 0, canvas.width, sliceCanvas.height);
      const sliceImg = sliceCanvas.toDataURL('image/jpeg', 0.90);
      const sliceHeightMm = sliceCanvas.height / pxPerMm;
      if(y > 0) pdf.addPage('a4', 'landscape');
      pdf.addImage(sliceImg, 'JPEG', 0, 0, pageWidth, sliceHeightMm);
      y += slicePx;
    }
  }

  container.remove(); pdf.save('DryStoreStockRecord.pdf');
}

// Wire buttons
document.getElementById('addBtn').addEventListener('click', ()=> addRow());
document.getElementById('saveBtn').addEventListener('click', saveRows);
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('pdfBtn').addEventListener('click', downloadPDF);

// Init
window.addEventListener('DOMContentLoaded', ()=>{
  loadSavedList();
  // if no rows, add a starter row
  if(!document.querySelector('#tbody tr')) addRow();
});

</script>

</body>
</html>
