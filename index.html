<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Food Quality & Taste Check — Konarak F&B</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  :root { --container-max: 980px; }
  body { font-family: Arial, Helvetica, sans-serif; background:#f6f6f6; padding:12px; }
  .container { max-width: var(--container-max); margin:auto; background:#fff; border:1px solid #dcdcdc; padding:12px; }

  .header { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .logo { flex:0 0 72px; }
  .logo img { max-height:54px; width:auto; }
  .title { flex:1; text-align:center; font-weight:700; font-size:18px; }
  .spacer { flex:0 0 72px; }

  .meta-grid { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .meta-item { flex:1 1 180px; min-width:140px; }
  .meta-item label { font-weight:700; font-size:13px; margin-bottom:4px; display:block; }
  .meta-item input { width:100%; padding:8px; border:1px solid #999; border-radius:4px; }

  .table-wrap { margin-top:12px; overflow-x:auto; }
  table { width:100%; border-collapse:collapse; min-width:960px; }
  th, td { border:1px solid #bbb; padding:6px; font-size:13px; text-align:center; }
  th { background:#f1f1f1; font-weight:700; }
  table input, table select { width:96%; padding:6px; }

  .controls { display:flex; gap:8px; margin-top:12px; }
  .controls button { padding:10px 12px; font-size:15px; border:none; color:#fff; border-radius:6px; cursor:pointer; }
  .btn-add{ background:#198754; }
  .btn-save{ background:#0d6efd; }
  .btn-pdf{ background:#ff9800; }

  .btn-del { background:#d9534f; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }

  .notes { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
  .note-box { flex:1 1 300px; min-width:300px; border:1px solid #999; padding:8px; }
  .note-box h4 { margin:0 0 6px 0; font-size:13px; }

  .footer-row { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
  .footer-box { flex:1 1 300px; border:1px solid #999; padding:10px; min-height:48px; }

  .bottom-controls { margin-top:14px; display:flex; }
  .bottom-controls button { flex:1; }

</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="logo"><img id="logoImg" src="logo.png" alt="Logo" onerror="this.style.display='none'"></div>
    <div class="title">Daily Food Quality & Taste Check Report</div>
    <div class="spacer"></div>
  </div>

  <!-- METADATA -->
  <div class="meta-grid">
    <div class="meta-item">
      <label>Date</label>
      <input id="date" type="date">
    </div>

    <div class="meta-item">
      <label>Building</label>
      <input id="building" type="text">
    </div>

    <div class="meta-item">
      <label>Floor</label>
      <input id="floor" type="text">
    </div>

    <div class="meta-item">
      <label>Counter</label>
      <input id="counter" type="text">
    </div>

    <div class="meta-item">
      <label>Supervisor</label>
      <input id="supervisor" type="text">
    </div>

    <div class="meta-item">
      <label>CBRE Representative</label>
      <input id="cbre" type="text">
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-wrap">
    <table id="foodTable">
      <thead>
        <tr>
          <th style="width:42px">S.No</th>
          <th style="width:240px">Item</th>
          <th style="width:70px">Temp (°C)</th>
          <th style="width:80px">Freshness</th>
          <th style="width:70px">Taste</th>
          <th style="width:70px">Texture</th>
          <th style="width:70px">Appearance</th>
          <th style="width:60px">Portion</th>
          <th style="width:200px">Remarks</th>
          <th style="width:50px">Del</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><select><option>Good</option><option>Average</option><option>Poor</option></select></td>
          <td><select><option>Good</option><option>Average</option><option>Poor</option></select></td>
          <td><select><option>Soft</option><option>Normal</option><option>Hard</option></select></td>
          <td><select><option>Good</option><option>Average</option><option>Poor</option></select></td>
          <td><select><option>Std</option><option>Less</option></select></td>
          <td><input type="text"></td>
          <td><button class="btn-del" onclick="deleteRow(this)">X</button></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <button class="btn-add" onclick="addRow()">+ Add Row</button>
    <button class="btn-save" onclick="saveForm()">Save (local)</button>
  </div>

  <!-- NOTES -->
  <div class="notes">
    <div class="note-box">
      <h4>Taste Validation Notes</h4>
      <p id="tastePreview"></p>
    </div>
    <div class="note-box">
      <h4>Special Observations</h4>
      <p id="obsPreview"></p>
    </div>
    <div class="note-box">
      <h4>Corrective Actions</h4>
      <p id="actionsPreview"></p>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer-row">
    <div class="footer-box">Vendor PoC :</div>
    <div class="footer-box">Verified by F&B Team :</div>
  </div>

  <!-- DOWNLOAD -->
  <div class="bottom-controls">
    <button class="btn-pdf" onclick="downloadPDF()">Download PDF</button>
  </div>

</div>


<script>
/* ---------------- ADD / DELETE ROW ---------------- */

function addRow(){
  const tbody = document.querySelector("#foodTable tbody");
  const idx = tbody.rows.length + 1;
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${idx}</td>
    <td><input type="text"></td>
    <td><input type="text"></td>
    <td><select><option>Good</option><option>Average</option><option>Poor</option></select></td>
    <td><select><option>Good</option><option>Average</option><option>Poor</option></select></td>
    <td><select><option>Soft</option><option>Normal</option><option>Hard</option></select></td>
    <td><select><option>Good</option><option>Average</option><option>Poor</option></select></td>
    <td><select><option>Std</option><option>Less</option></select></td>
    <td><input type="text"></td>
    <td><button class="btn-del" onclick="deleteRow(this)">X</button></td>
  `;
  tbody.appendChild(tr);
}

function deleteRow(btn){
  btn.closest("tr").remove();
  const rows = document.querySelectorAll("#foodTable tbody tr");
  rows.forEach((r,i)=> r.cells[0].textContent = i+1);
}

/* ---------------- SAVE LOCAL ---------------- */

function saveForm(){
  const data = {
    date: date.value,
    building: building.value,
    floor: floor.value,
    counter: counter.value,
    supervisor: supervisor.value,
    cbre: cbre.value
  };
  localStorage.setItem("foodQuality", JSON.stringify(data));
  alert("Saved locally.");
}

/* ---------------- PDF GENERATION ---------------- */

async function downloadPDF(){

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

  const margin = 20;
  const pageWidth = doc.internal.pageSize.getWidth();
  const usableWidth = pageWidth - margin*2;
  let cursorY = margin;

  /* -------- LOGO (fixed no-stretch) -------- */

  let logoData = null;
  const logoEl = document.getElementById("logoImg");

  if(logoEl && logoEl.src && logoEl.style.display !== "none"){
    logoData = await toDataUrl(logoEl.src).catch(()=>null);
  }

  const logoH = 40;
  const logoW = 40 * 1.4;

  if(logoData){
    doc.addImage(logoData, "PNG", margin, cursorY, logoW, logoH, undefined, "FAST");
  }

  doc.setFontSize(16);
  doc.setFont(undefined,"bold");
  doc.text("Daily Food Quality & Taste Check Report", pageWidth/2, cursorY+28, {align:"center"});

  cursorY += 50;
  doc.line(margin, cursorY, pageWidth-margin, cursorY);
  cursorY += 10;

  /* -------- METADATA: OPTION B -------- */

  doc.setFontSize(10);
  const row1 = ["Date", date.value, "Building", building.value, "Floor", floor.value, "Counter", counter.value];
  const row2 = ["Supervisor", supervisor.value, "CBRE Rep", cbre.value];

  let x = margin;
  const cellW = usableWidth / 4;
  const cellH = 26;

  // Row 1 (four boxes)
  for(let i=0;i<4;i++){
    doc.rect(x, cursorY, cellW, cellH);
    doc.setFont(undefined,"bold"); doc.text(row1[i*2], x+6, cursorY+12);
    doc.setFont(undefined,"normal"); doc.text(row1[i*2+1], x+6, cursorY+22);
    x += cellW;
  }

  cursorY += cellH + 8;

  // Row 2 (two boxes)
  const cellW2 = usableWidth / 2;
  x = margin;

  for(let i=0;i<2;i++){
    doc.rect(x, cursorY, cellW2, cellH);
    doc.setFont(undefined,"bold"); doc.text(row2[i*2], x+6, cursorY+12);
    doc.setFont(undefined,"normal"); doc.text(row2[i*2+1], x+6, cursorY+22);
    x += cellW2;
  }

  cursorY += cellH + 15;

  /* -------- TABLE -------- */

  const rows = Array.from(document.querySelectorAll("#foodTable tbody tr")).map((tr,i)=>{
    const t = tr.querySelectorAll("td");
    return [
      i+1,
      t[1].querySelector("input").value,
      t[2].querySelector("input").value,
      t[3].querySelector("select").value,
      t[4].querySelector("select").value,
      t[5].querySelector("select").value,
      t[6].querySelector("select").value,
      t[7].querySelector("select").value,
      t[8].querySelector("input").value
    ];
  });

  doc.autoTable({
    startY: cursorY,
    head:[["S.No","Item","Temp","Freshness","Taste","Texture","Appearance","Portion","Remarks"]],
    body: rows,
    margin:{left:margin, right:margin},
    styles:{fontSize:10, cellPadding:5, valign:"middle"},
    columnStyles:{
      0:{cellWidth:28},
      1:{cellWidth:180},
      2:{cellWidth:55},
      3:{cellWidth:70},
      4:{cellWidth:60},
      5:{cellWidth:60},
      6:{cellWidth:60},
      7:{cellWidth:55},
      8:{cellWidth:150}   /* FIXED REMARKS WIDTH */
    }
  });

  cursorY = doc.lastAutoTable.finalY + 20;

  /* -------- FOOTER -------- */

  const sigH = 45;
  const sigW = (usableWidth - 20)/2;

  doc.rect(margin, cursorY, sigW, sigH);
  doc.text("Vendor PoC :", margin+10, cursorY+20);

  doc.rect(margin+sigW+20, cursorY, sigW, sigH);
  doc.text("Verified by F&B Team :", margin+sigW+30, cursorY+20);

  doc.save("Food_Quality_Check.pdf");

  /* ------- Helper function ------- */
  function toDataUrl(src){
    return new Promise((resolve)=>{
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = function(){
        const c = document.createElement("canvas");
        c.width = this.width; c.height = this.height;
        c.getContext("2d").drawImage(this,0,0);
        resolve(c.toDataURL("image/png"));
      };
      img.onerror = ()=>resolve(null);
      img.src = src;
    });
  }
}
</script>

</body>
</html>
